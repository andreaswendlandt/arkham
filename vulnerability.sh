#!/bin/bash
# todo next: better variable naming, improve output 

# ensure this script started with root privileges
if [ $(id -u) -ne 0 ]; then
    echo "ERROR: This script must be run as root"
    exit 1
fi

# logging
logfile=/var/log/$(basename $0).log
mylog(){
    echo "$(date) $@" >>$logfile
}

# ensure we are the only running instance
lock_err(){
    mylog "ERROR, another instance is already running, aborting!!!"
    exit 1
}

pidfile="/var/run/$(basename $0)"
exec 300>$pidfile
flock -n 300 || lock_err
pid=$$
echo $pid 1>&300

# required packages: nmap, flock
required_packages=(nmap flock)
max=${#required_packages[*]}
i=0
packages_present=""
while (( i < max ))
do
    if ! dpkg -l ${required_packages[$i]} >/dev/null 2>&1 && ! which ${required_packages[$i]} >/dev/null 2>&1; then
        packages_present="$packages_present ${required_packages[$i]}"
    fi
    i=$(expr $i + 1)
done

if ! [ -z "$packages_present" ]; then
    mylog "WARNING, $packages_present missing on this system, skipping the dedicated sections and not doing a full scan"
fi
echo $packages_present

# network section
open_ports=$(nmap -v localhost | egrep '^[[:digit:]]' | awk '$2 ~ open {print $1}')
echo -e "these ports are open: \n$open_ports"

# user section
